{
    "openapi": "3.0.0",
    "info": {
        "title": "Pharo Smalltalk Interop Server API",
        "version": "3.2.0",
        "description": "RESTful API for Smalltalk code introspection, manipulation, UI debugging, and settings management"
    },
    "servers": [
        {
            "url": "http://localhost:8086"
        }
    ],
    "paths": {
        "/eval": {
            "post": {
                "summary": "Evaluate Smalltalk code and return the result",
                "requestBody": {
                    "required": true,
                    "content": {
                        "application/json": {
                            "schema": {
                                "type": "object",
                                "properties": {
                                    "code": {
                                        "type": "string"
                                    }
                                },
                                "required": [
                                    "code"
                                ]
                            }
                        }
                    }
                },
                "responses": {
                    "200": {
                        "$ref": "#/components/responses/DefaultResponse"
                    }
                }
            }
        },
        "/apply-settings": {
            "post": {
                "summary": "Apply server settings dynamically",
                "description": "Updates server settings. Settings are applied immediately and persist for the current server session. Keys can be provided in either camelCase or snake_case format (e.g., 'stackSize' or 'stack_size'), and snake_case keys are automatically normalized to camelCase.",
                "requestBody": {
                    "required": true,
                    "content": {
                        "application/json": {
                            "schema": {
                                "type": "object",
                                "properties": {
                                    "settings": {
                                        "$ref": "#/components/schemas/SettingsObject"
                                    }
                                },
                                "required": [
                                    "settings"
                                ]
                            }
                        }
                    }
                },
                "responses": {
                    "200": {
                        "$ref": "#/components/responses/StringResponse"
                    }
                }
            }
        },
        "/get-settings": {
            "get": {
                "summary": "Get current server settings",
                "description": "Retrieves all current server settings as a dictionary",
                "responses": {
                    "200": {
                        "$ref": "#/components/responses/SettingsResponse"
                    }
                }
            }
        },
        "/list-packages": {
            "get": {
                "summary": "Get list of all packages",
                "responses": {
                    "200": {
                        "$ref": "#/components/responses/StringArrayResponse"
                    }
                }
            }
        },
        "/list-classes": {
            "get": {
                "summary": "Get list of classes in a package",
                "parameters": [
                    {
                        "name": "package_name",
                        "in": "query",
                        "required": true,
                        "schema": {
                            "type": "string"
                        }
                    }
                ],
                "responses": {
                    "200": {
                        "$ref": "#/components/responses/StringArrayResponse"
                    }
                }
            }
        },
        "/list-extended-classes": {
            "get": {
                "summary": "Get list of extended classes in a package",
                "parameters": [
                    {
                        "name": "package_name",
                        "in": "query",
                        "required": true,
                        "schema": {
                            "type": "string"
                        }
                    }
                ],
                "responses": {
                    "200": {
                        "$ref": "#/components/responses/StringArrayResponse"
                    }
                }
            }
        },
        "/list-methods": {
            "get": {
                "summary": "Get list of methods in a package",
                "parameters": [
                    {
                        "name": "package_name",
                        "in": "query",
                        "required": true,
                        "schema": {
                            "type": "string"
                        }
                    }
                ],
                "responses": {
                    "200": {
                        "$ref": "#/components/responses/MethodNameArrayResponse"
                    }
                }
            }
        },
        "/get-class-source": {
            "get": {
                "summary": "Get source code of a class",
                "parameters": [
                    {
                        "name": "class_name",
                        "in": "query",
                        "required": true,
                        "schema": {
                            "type": "string"
                        }
                    }
                ],
                "responses": {
                    "200": {
                        "$ref": "#/components/responses/StringResponse"
                    }
                }
            }
        },
        "/get-method-source": {
            "get": {
                "summary": "Get source code of a specific method",
                "description": "Get source code of a specific method. For class-side methods, you can either set is_class_method=true or append ' class' to the class name (legacy syntax).",
                "parameters": [
                    {
                        "name": "class_name",
                        "in": "query",
                        "required": true,
                        "schema": {
                            "type": "string"
                        },
                        "description": "Class name without ' class' suffix when using is_class_method parameter"
                    },
                    {
                        "name": "method_name",
                        "in": "query",
                        "required": true,
                        "schema": {
                            "type": "string"
                        },
                        "description": "Method selector name"
                    },
                    {
                        "name": "is_class_method",
                        "in": "query",
                        "required": false,
                        "schema": {
                            "type": "string",
                            "enum": [
                                "true",
                                "false"
                            ],
                            "default": "false"
                        },
                        "description": "Set to 'true' to retrieve a class-side method, 'false' for instance-side method. Provides a cleaner alternative to appending ' class' to class_name."
                    }
                ],
                "responses": {
                    "200": {
                        "$ref": "#/components/responses/StringResponse"
                    }
                }
            }
        },
        "/get-class-comment": {
            "get": {
                "summary": "Get comment of a class",
                "parameters": [
                    {
                        "name": "class_name",
                        "in": "query",
                        "required": true,
                        "schema": {
                            "type": "string"
                        }
                    }
                ],
                "responses": {
                    "200": {
                        "$ref": "#/components/responses/StringResponse"
                    }
                }
            }
        },
        "/search-classes-like": {
            "get": {
                "summary": "Search class names that start with the given query (case-insensitive)",
                "parameters": [
                    {
                        "name": "class_name_query",
                        "in": "query",
                        "required": true,
                        "schema": {
                            "type": "string"
                        }
                    }
                ],
                "responses": {
                    "200": {
                        "$ref": "#/components/responses/StringArrayResponse"
                    }
                }
            }
        },
        "/search-traits-like": {
            "get": {
                "summary": "Search trait names that start with the given query (case-insensitive)",
                "parameters": [
                    {
                        "name": "trait_name_query",
                        "in": "query",
                        "required": true,
                        "schema": {
                            "type": "string"
                        }
                    }
                ],
                "responses": {
                    "200": {
                        "$ref": "#/components/responses/StringArrayResponse"
                    }
                }
            }
        },
        "/search-methods-like": {
            "get": {
                "summary": "Search method selectors that start with the given query",
                "parameters": [
                    {
                        "name": "method_name_query",
                        "in": "query",
                        "required": true,
                        "schema": {
                            "type": "string"
                        }
                    }
                ],
                "responses": {
                    "200": {
                        "$ref": "#/components/responses/StringArrayResponse"
                    }
                }
            }
        },
        "/search-references": {
            "get": {
                "summary": "Find all references to a given symbol (method/variable/class)",
                "parameters": [
                    {
                        "name": "program_symbol",
                        "in": "query",
                        "required": true,
                        "schema": {
                            "type": "string"
                        }
                    }
                ],
                "responses": {
                    "200": {
                        "$ref": "#/components/responses/ClassMethodPackageDictArrayResponse"
                    }
                }
            }
        },
        "/search-implementors": {
            "get": {
                "summary": "Find all implementors of a given method selector",
                "parameters": [
                    {
                        "name": "method_name",
                        "in": "query",
                        "required": true,
                        "schema": {
                            "type": "string"
                        }
                    }
                ],
                "responses": {
                    "200": {
                        "$ref": "#/components/responses/ClassMethodPackageDictArrayResponse"
                    }
                }
            }
        },
        "/search-references-to-class": {
            "get": {
                "summary": "Find all references to a given class",
                "parameters": [
                    {
                        "name": "class_name",
                        "in": "query",
                        "required": true,
                        "schema": {
                            "type": "string"
                        }
                    }
                ],
                "responses": {
                    "200": {
                        "$ref": "#/components/responses/ClassMethodPackageDictArrayResponse"
                    }
                }
            }
        },
        "/export-package": {
            "get": {
                "summary": "Export package to specified path",
                "parameters": [
                    {
                        "name": "package_name",
                        "in": "query",
                        "required": true,
                        "schema": {
                            "type": "string"
                        }
                    },
                    {
                        "name": "path",
                        "in": "query",
                        "required": true,
                        "schema": {
                            "type": "string"
                        }
                    }
                ],
                "responses": {
                    "200": {
                        "$ref": "#/components/responses/StringResponse"
                    }
                }
            }
        },
        "/import-package": {
            "get": {
                "summary": "Import package from specified path",
                "parameters": [
                    {
                        "name": "package_name",
                        "in": "query",
                        "required": true,
                        "schema": {
                            "type": "string"
                        }
                    },
                    {
                        "name": "path",
                        "in": "query",
                        "required": true,
                        "schema": {
                            "type": "string"
                        }
                    }
                ],
                "responses": {
                    "200": {
                        "$ref": "#/components/responses/StringResponse"
                    }
                }
            }
        },
        "/run-package-test": {
            "get": {
                "summary": "Run all tests in a package",
                "parameters": [
                    {
                        "name": "package_name",
                        "in": "query",
                        "required": true,
                        "schema": {
                            "type": "string"
                        }
                    }
                ],
                "responses": {
                    "200": {
                        "$ref": "#/components/responses/StringResponse"
                    }
                }
            }
        },
        "/run-class-test": {
            "get": {
                "summary": "Run all tests in a class",
                "parameters": [
                    {
                        "name": "class_name",
                        "in": "query",
                        "required": true,
                        "schema": {
                            "type": "string"
                        }
                    }
                ],
                "responses": {
                    "200": {
                        "$ref": "#/components/responses/StringResponse"
                    }
                }
            }
        },
        "/install-project": {
            "get": {
                "summary": "Install a project using Metacello",
                "parameters": [
                    {
                        "name": "project_name",
                        "in": "query",
                        "required": true,
                        "schema": {
                            "type": "string"
                        }
                    },
                    {
                        "name": "repository_url",
                        "in": "query",
                        "required": true,
                        "schema": {
                            "type": "string"
                        }
                    },
                    {
                        "name": "load_groups",
                        "in": "query",
                        "required": false,
                        "schema": {
                            "type": "string"
                        },
                        "description": "Comma-separated list of groups to load"
                    }
                ],
                "responses": {
                    "200": {
                        "$ref": "#/components/responses/StringResponse"
                    }
                }
            }
        },
        "/read-screen": {
            "get": {
                "summary": "Capture screenshot and extract UI structure for debugging Pharo UI",
                "description": "UI screen reader for debugging Pharo UI issues. Captures screenshots and extracts morph hierarchy with bounds, colors, and structure. Supports World morphs, Spec presenters, and Roassal visualizations.",
                "parameters": [
                    {
                        "name": "target_type",
                        "in": "query",
                        "required": false,
                        "schema": {
                            "type": "string",
                            "enum": [
                                "world",
                                "spec",
                                "roassal"
                            ],
                            "default": "world"
                        },
                        "description": "UI type to inspect: 'world' (morphs), 'spec' (Spec windows/presenters), or 'roassal' (Roassal canvases)"
                    },
                    {
                        "name": "capture_screenshot",
                        "in": "query",
                        "required": false,
                        "schema": {
                            "type": "string",
                            "enum": [
                                "true",
                                "false"
                            ],
                            "default": "true"
                        },
                        "description": "Include PNG screenshot in response"
                    }
                ],
                "responses": {
                    "200": {
                        "$ref": "#/components/responses/ReadScreenResponse"
                    }
                }
            }
        }
    },
    "components": {
        "schemas": {
            "SettingsObject": {
                "type": "object",
                "description": "Server settings dictionary. Keys can be specified in either camelCase or snake_case format (e.g., 'stackSize' or 'stack_size'). Snake_case keys are automatically normalized to camelCase. Keys and values can be customized.",
                "properties": {
                    "stackSize": {
                        "type": "integer",
                        "description": "Maximum stack trace depth for error reporting (also accepts 'stack_size')",
                        "default": 100
                    }
                },
                "additionalProperties": true,
                "example": {
                    "stackSize": 150,
                    "stack_size": 150,
                    "customKey": "value",
                    "custom_key": "value"
                }
            },
            "Bounds": {
                "type": "object",
                "properties": {
                    "x": {
                        "type": "integer",
                        "description": "Left coordinate"
                    },
                    "y": {
                        "type": "integer",
                        "description": "Top coordinate"
                    },
                    "width": {
                        "type": "integer",
                        "description": "Width of the element"
                    },
                    "height": {
                        "type": "integer",
                        "description": "Height of the element"
                    }
                },
                "required": [
                    "x",
                    "y",
                    "width",
                    "height"
                ]
            },
            "MorphData": {
                "type": "object",
                "properties": {
                    "class": {
                        "type": "string",
                        "description": "Morph class name"
                    },
                    "bounds": {
                        "$ref": "#/components/schemas/Bounds"
                    },
                    "visible": {
                        "type": "boolean"
                    },
                    "backgroundColor": {
                        "type": "string"
                    },
                    "owner": {
                        "type": "string"
                    },
                    "submorphCount": {
                        "type": "integer"
                    },
                    "text": {
                        "type": "string"
                    }
                },
                "required": [
                    "class",
                    "bounds",
                    "visible",
                    "submorphCount"
                ]
            },
            "PresenterInfo": {
                "type": "object",
                "properties": {
                    "class": {
                        "type": "string"
                    },
                    "name": {
                        "type": "string"
                    },
                    "label": {
                        "type": "string"
                    },
                    "text": {
                        "type": "string"
                    },
                    "value": {
                        "type": "string"
                    },
                    "placeholder": {
                        "type": "string"
                    },
                    "isEnabled": {
                        "type": "boolean"
                    },
                    "isVisible": {
                        "type": "boolean"
                    },
                    "childCount": {
                        "type": "integer"
                    },
                    "children": {
                        "type": "array",
                        "items": {
                            "$ref": "#/components/schemas/PresenterInfo"
                        }
                    }
                },
                "required": [
                    "class",
                    "childCount",
                    "children"
                ]
            },
            "RoassalShapeInfo": {
                "type": "object",
                "properties": {
                    "class": {
                        "type": "string"
                    },
                    "position": {
                        "type": "string"
                    },
                    "extent": {
                        "type": "string"
                    },
                    "color": {
                        "type": "string"
                    },
                    "text": {
                        "type": "string"
                    },
                    "label": {
                        "type": "string"
                    }
                },
                "required": [
                    "class"
                ]
            },
            "RoassalEdgeInfo": {
                "type": "object",
                "properties": {
                    "class": {
                        "type": "string"
                    },
                    "from": {
                        "type": "string"
                    },
                    "to": {
                        "type": "string"
                    },
                    "color": {
                        "type": "string"
                    },
                    "label": {
                        "type": "string"
                    }
                },
                "required": [
                    "class"
                ]
            },
            "RoassalCanvasInfo": {
                "type": "object",
                "properties": {
                    "class": {
                        "type": "string"
                    },
                    "canvasClass": {
                        "type": "string"
                    },
                    "bounds": {
                        "$ref": "#/components/schemas/Bounds"
                    },
                    "visible": {
                        "type": "boolean"
                    },
                    "backgroundColor": {
                        "type": "string"
                    },
                    "zoomLevel": {
                        "type": "string"
                    },
                    "canvasExtent": {
                        "type": "string"
                    },
                    "shapeCount": {
                        "type": "integer"
                    },
                    "shapes": {
                        "type": "array",
                        "items": {
                            "$ref": "#/components/schemas/RoassalShapeInfo"
                        }
                    },
                    "edgeCount": {
                        "type": "integer"
                    },
                    "edges": {
                        "type": "array",
                        "items": {
                            "$ref": "#/components/schemas/RoassalEdgeInfo"
                        }
                    },
                    "nodeCount": {
                        "type": "integer"
                    }
                },
                "required": [
                    "class"
                ]
            },
            "WindowInfo": {
                "type": "object",
                "properties": {
                    "title": {
                        "type": "string"
                    },
                    "class": {
                        "type": "string"
                    },
                    "extent": {
                        "type": "string"
                    },
                    "position": {
                        "type": "string"
                    },
                    "isMaximized": {
                        "type": "boolean"
                    },
                    "isMinimized": {
                        "type": "boolean"
                    },
                    "isResizable": {
                        "type": "boolean"
                    },
                    "hasMenu": {
                        "type": "boolean"
                    },
                    "hasToolbar": {
                        "type": "boolean"
                    },
                    "hasStatusbar": {
                        "type": "boolean"
                    },
                    "presenter": {
                        "$ref": "#/components/schemas/PresenterInfo"
                    }
                },
                "required": [
                    "class"
                ]
            },
            "WorldStructure": {
                "type": "object",
                "properties": {
                    "totalMorphs": {
                        "type": "integer"
                    },
                    "displayedMorphCount": {
                        "type": "integer"
                    },
                    "morphs": {
                        "type": "array",
                        "items": {
                            "$ref": "#/components/schemas/MorphData"
                        }
                    }
                },
                "required": [
                    "totalMorphs",
                    "displayedMorphCount",
                    "morphs"
                ]
            },
            "SpecStructure": {
                "type": "object",
                "properties": {
                    "windowCount": {
                        "type": "integer"
                    },
                    "presenters": {
                        "type": "array",
                        "items": {
                            "$ref": "#/components/schemas/WindowInfo"
                        }
                    }
                },
                "required": [
                    "presenters"
                ]
            },
            "RoassalStructure": {
                "type": "object",
                "properties": {
                    "canvasCount": {
                        "type": "integer"
                    },
                    "canvases": {
                        "type": "array",
                        "items": {
                            "$ref": "#/components/schemas/RoassalCanvasInfo"
                        }
                    }
                },
                "required": [
                    "canvases"
                ]
            },
            "ReadScreenResult": {
                "type": "object",
                "properties": {
                    "screenshot": {
                        "type": "string",
                        "description": "Path to the screenshot PNG file in temp directory"
                    },
                    "target_type": {
                        "type": "string",
                        "enum": [
                            "world",
                            "spec",
                            "roassal"
                        ]
                    },
                    "structure": {
                        "oneOf": [
                            {
                                "$ref": "#/components/schemas/WorldStructure"
                            },
                            {
                                "$ref": "#/components/schemas/SpecStructure"
                            },
                            {
                                "$ref": "#/components/schemas/RoassalStructure"
                            }
                        ]
                    },
                    "summary": {
                        "type": "string",
                        "description": "Human-readable summary of the UI structure"
                    }
                },
                "required": [
                    "target_type",
                    "structure",
                    "summary"
                ]
            },
            "ErrorDetails": {
                "type": "object",
                "properties": {
                    "description": {
                        "type": "string",
                        "description": "Brief error type or message"
                    },
                    "stack_trace": {
                        "type": "string",
                        "description": "Complete stack trace showing the call chain that led to the error"
                    },
                    "receiver": {
                        "type": "object",
                        "properties": {
                            "class": {
                                "type": "string",
                                "description": "The class of the receiver object"
                            },
                            "self": {
                                "type": "string",
                                "description": "String representation of the receiver object"
                            },
                            "variables": {
                                "type": "object",
                                "additionalProperties": {
                                    "type": "string"
                                },
                                "description": "Instance variables of the receiver object with their names and values"
                            }
                        },
                        "required": [
                            "class",
                            "self",
                            "variables"
                        ],
                        "description": "Information about the object that received the message causing the error"
                    }
                },
                "required": [
                    "description"
                ]
            },
            "Error": {
                "oneOf": [
                    {
                        "type": "string",
                        "description": "Simple error message for basic errors"
                    },
                    {
                        "$ref": "#/components/schemas/ErrorDetails"
                    }
                ]
            }
        },
        "responses": {
            "DefaultResponse": {
                "description": "Standard response",
                "content": {
                    "application/json": {
                        "schema": {
                            "type": "object",
                            "properties": {
                                "success": {
                                    "type": "boolean"
                                },
                                "result": {},
                                "error": {
                                    "$ref": "#/components/schemas/Error"
                                }
                            }
                        }
                    }
                }
            },
            "StringResponse": {
                "description": "Response with string result",
                "content": {
                    "application/json": {
                        "schema": {
                            "type": "object",
                            "properties": {
                                "success": {
                                    "type": "boolean"
                                },
                                "result": {
                                    "type": "string"
                                },
                                "error": {
                                    "$ref": "#/components/schemas/Error"
                                }
                            }
                        }
                    }
                }
            },
            "StringArrayResponse": {
                "description": "Response with string array result",
                "content": {
                    "application/json": {
                        "schema": {
                            "type": "object",
                            "properties": {
                                "success": {
                                    "type": "boolean"
                                },
                                "result": {
                                    "type": "array",
                                    "items": {
                                        "type": "string"
                                    }
                                },
                                "error": {
                                    "$ref": "#/components/schemas/Error"
                                }
                            }
                        }
                    }
                }
            },
            "MethodNameArrayResponse": {
                "description": "Response with method name array result (ClassName>>#methodName format)",
                "content": {
                    "application/json": {
                        "schema": {
                            "type": "object",
                            "properties": {
                                "success": {
                                    "type": "boolean"
                                },
                                "result": {
                                    "type": "array",
                                    "items": {
                                        "type": "string",
                                        "pattern": "^[^>]+>>#[^>]+$"
                                    }
                                },
                                "error": {
                                    "$ref": "#/components/schemas/Error"
                                }
                            }
                        }
                    }
                }
            },
            "ClassMethodPackageDictArrayResponse": {
                "description": "Response with class/method/package dictionary array result",
                "content": {
                    "application/json": {
                        "schema": {
                            "type": "object",
                            "properties": {
                                "success": {
                                    "type": "boolean"
                                },
                                "result": {
                                    "type": "array",
                                    "items": {
                                        "type": "object",
                                        "properties": {
                                            "class": {
                                                "type": "string"
                                            },
                                            "method": {
                                                "type": "string"
                                            },
                                            "package": {
                                                "type": "string"
                                            }
                                        },
                                        "required": [
                                            "class",
                                            "method",
                                            "package"
                                        ]
                                    }
                                },
                                "error": {
                                    "$ref": "#/components/schemas/Error"
                                }
                            }
                        }
                    }
                }
            },
            "PackageClassMethodDictArrayResponse": {
                "description": "Response with package/class/method dictionary array result",
                "content": {
                    "application/json": {
                        "schema": {
                            "type": "object",
                            "properties": {
                                "success": {
                                    "type": "boolean"
                                },
                                "result": {
                                    "type": "array",
                                    "items": {
                                        "type": "object",
                                        "properties": {
                                            "package": {
                                                "type": "string"
                                            },
                                            "class": {
                                                "type": "string"
                                            },
                                            "method": {
                                                "type": "string"
                                            }
                                        },
                                        "required": [
                                            "package",
                                            "class",
                                            "method"
                                        ]
                                    }
                                },
                                "error": {
                                    "$ref": "#/components/schemas/Error"
                                }
                            }
                        }
                    }
                }
            },
            "ReadScreenResponse": {
                "description": "Response with UI structure and optional screenshot",
                "content": {
                    "application/json": {
                        "schema": {
                            "type": "object",
                            "properties": {
                                "success": {
                                    "type": "boolean"
                                },
                                "result": {
                                    "$ref": "#/components/schemas/ReadScreenResult"
                                },
                                "error": {
                                    "$ref": "#/components/schemas/Error"
                                }
                            }
                        }
                    }
                }
            },
            "SettingsResponse": {
                "description": "Response with current server settings",
                "content": {
                    "application/json": {
                        "schema": {
                            "type": "object",
                            "properties": {
                                "success": {
                                    "type": "boolean"
                                },
                                "result": {
                                    "$ref": "#/components/schemas/SettingsObject"
                                },
                                "error": {
                                    "$ref": "#/components/schemas/Error"
                                }
                            }
                        }
                    }
                }
            }
        }
    }
}